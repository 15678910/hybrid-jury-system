class d{constructor(){this.chunks=[],this.vocabulary=[],this.embeddings=[],this.embeddingMap=new Map,this.isLoaded=!1}async load(){if(!this.isLoaded)try{const t=Date.now(),[r,n]=await Promise.all([fetch(`/pdfChunks.json?v=${t}`),fetch(`/embeddings.json?v=${t}`)]),c=await r.json(),o=await n.json();this.chunks=c.chunks,this.vocabulary=o.vocabulary,this.embeddings=o.embeddings,this.embeddings.forEach(e=>{this.embeddingMap.set(e.id,e.vector)}),this.isLoaded=!0,console.log("벡터 검색 데이터 로드 완료:",this.getStats()),console.log("북한 in vocabulary:",this.vocabulary.includes("북한"),"index:",this.vocabulary.indexOf("북한"))}catch(t){throw console.error("벡터 검색 데이터 로드 실패:",t),t}}textToVector(t){const r=t.toLowerCase().match(/[가-힣]{2,}|[a-zA-Z]{3,}/g)||[],n=new Array(this.vocabulary.length).fill(0);r.forEach(e=>{const s=this.vocabulary.indexOf(e);s!==-1&&(n[s]+=1)}),["북한","남한","중국","러시아","일본","미국","영국","호주","독일","프랑스","핀란드","스웨덴","덴마크","노르웨이"].forEach(e=>{if(t.includes(e)){const s=this.vocabulary.indexOf(e);s!==-1&&n[s]===0&&(n[s]=1)}});const o=Math.sqrt(n.reduce((e,s)=>e+s*s,0));if(o>0)for(let e=0;e<n.length;e++)n[e]/=o;return n}cosineSimilarity(t,r){if(t.length!==r.length)return 0;let n=0,c=0,o=0;for(let e=0;e<t.length;e++)n+=t[e]*r[e],c+=t[e]*t[e],o+=r[e]*r[e];return c=Math.sqrt(c),o=Math.sqrt(o),c===0||o===0?0:n/(c*o)}keywordMatchScore(t,r){const n=t.toLowerCase().match(/[가-힣]{2,}|[a-zA-Z]{3,}/g)||[],c=r.keywords||[],o=r.text||"";let e=0;n.forEach(i=>{c.forEach(l=>{(i.includes(l)||l.includes(i))&&(e+=1)})});const s=["핀란드","독일","스웨덴","프랑스","일본","덴마크","노르웨이","유럽","한국","북한","중국","러시아","배심","참심","시민법관","혼합형"];let a=0;return s.forEach(i=>{t.includes(i)&&o.includes(i)&&(e+=5,a++)}),a>=2&&(e+=a*10),n.forEach(i=>{o.toLowerCase().includes(i)&&(e+=.5)}),e}search(t,r=3,n=.01){if(!this.isLoaded)return console.warn("벡터 검색 데이터가 로드되지 않았습니다."),[];const c=this.textToVector(t);console.log("검색 쿼리:",t),console.log("쿼리 벡터 non-zero 요소:",c.filter(s=>s>0).length);const o=this.vocabulary.indexOf("북한");t.includes("북한")&&console.log("북한 검색 디버그 - vocabulary index:",o,"queryVector[nkIndex]:",o>=0?c[o]:"N/A");const e=this.chunks.map(s=>{const a=this.embeddingMap.get(s.id);if(!a)return{chunk:s,score:0};const i=this.cosineSimilarity(c,a),l=this.keywordMatchScore(t,s)*.1,u=i*.5+l*.5;return{chunk:s,score:u}}).filter(s=>s.score>=n).sort((s,a)=>a.score-s.score).slice(0,r);return console.log("검색 결과 수:",e.length),e.length>0&&console.log("상위 결과:",e[0].chunk.source,"점수:",e[0].score),e.map(s=>({...s.chunk,score:s.score}))}getContextString(t,r=3){const n=this.search(t,r);return n.length===0?null:n.map((o,e)=>{const s=this.getSourceLabel(o.source);return`[참고자료 ${e+1}: ${s}]
${o.text}`}).join(`

`)}getSourceLabel(t){return{"Characteristics of European Union Justice_kr":"EU 사법제도",FULLTEXT01sweden_kr:"스웨덴 참심제",HoffmannHollandPutzerLayJudgesGermany_kr:"독일 참심원 제도",karhu_jenna_fin_kr:"핀란드 사법참여",Madeleine_Rundberg_SOLM02_Masters_Thesis_2022sweden_kr:"스웨덴 참심제 논문","Sanni Tolonen_fin_kr":"핀란드 참심제","ssrn-2665612eu_kr":"EU 사법 연구",TIV_Lautamies_esite_A5_FIN_kr:"핀란드 참심원 안내",korea_mixed_jury_system:"한국 혼합형 참심제",proposal:"제안 법률안",시민이재판을1:"시민이 재판을 (참심제 연구)","형사재판절차에 있어서 배심 및 참심제도의 도입방안":"배심 및 참심제도 도입방안",검찰의세계세계의검찰:"검찰의 세계 세계의 검찰"}[t]||t}getChunkById(t){return this.chunks.find(r=>r.id===t)}getStats(){return{totalChunks:this.chunks.length,vocabularySize:this.vocabulary.length,sources:[...new Set(this.chunks.map(t=>t.source))]}}}let h=null;async function g(){return h||(h=new d,await h.load()),h}export{g};
