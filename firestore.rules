rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // users 컬렉션: 사용자 정보 (Google/Kakao 로그인)
    match /users/{userId} {
      // 읽기: 본인만 가능
      allow read: if request.auth != null && request.auth.uid == userId;

      // 생성/수정: 인증된 사용자 또는 카카오 로그인 사용자 허용
      // 카카오 로그인은 Firebase Auth를 거치지 않으므로 userId 패턴으로 허용
      allow create, update: if request.auth != null
                            || (request.resource.data.provider == 'kakao'
                                && userId.matches('kakao_[0-9]+'));

      // 삭제: 불가
      allow delete: if false;
    }

    // signatures 컬렉션: 서명 데이터
    match /signatures/{signatureId} {
      // 읽기: 모든 사용자 허용 (공개 서명 목록)
      allow read: if true;

      // 생성: 필수 필드가 있고 유효한 데이터인 경우만 허용
      allow create: if request.resource.data.keys().hasAll(['name', 'phone', 'type', 'timestamp'])
                    && request.resource.data.name is string
                    && request.resource.data.name.size() > 0
                    && request.resource.data.name.size() <= 50
                    && request.resource.data.phone is string
                    && request.resource.data.type in ['individual', 'organization'];

      // 수정/삭제: 불가 (서명은 수정/삭제 불가)
      allow update, delete: if false;
    }

    // posts 컬렉션: 블로그 글
    match /posts/{postId} {
      // 읽기: 모든 사용자 허용 (공개 블로그)
      allow read: if true;

      // 생성: 필수 필드가 있는 경우 허용
      allow create: if request.auth != null
                    && request.resource.data.keys().hasAll(['title', 'content', 'author'])
                    && request.resource.data.title is string
                    && request.resource.data.content is string;

      // 수정: 글 내용(title, content, author, updatedAt, musicUrl, imageUrl) 또는 좋아요(likes, views) 허용
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['title', 'content', 'author', 'updatedAt', 'likes', 'views', 'summary', 'category', 'musicUrl', 'imageUrl']);

      allow delete: if false;

      // 댓글 서브컬렉션
      match /comments/{commentId} {
        allow read: if true;
        allow create: if request.resource.data.keys().hasAll(['nickname', 'content'])
                      && request.resource.data.nickname is string
                      && request.resource.data.content is string;
        allow update, delete: if false;
      }
    }

    // videos 컬렉션: 동영상
    match /videos/{videoId} {
      // 읽기: 모든 사용자 허용 (공개 동영상 목록)
      allow read: if true;

      // 생성: 필수 필드 검증
      allow create: if request.resource.data.keys().hasAll(['title', 'videoId'])
                    && request.resource.data.title is string
                    && request.resource.data.title.size() > 0
                    && request.resource.data.title.size() <= 200;

      // 수정: 제목, 설명, 카테고리, 좋아요(likes, views) 필드 업데이트 허용
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['title', 'description', 'category', 'videoId', 'likes', 'views', 'updatedAt']);

      allow delete: if false;
    }

    // cardnews 컬렉션: 카드뉴스
    match /cardnews/{cardId} {
      // 읽기: 모든 사용자 허용 (공개 카드뉴스)
      allow read: if true;

      // 생성: 필수 필드 검증
      allow create: if request.resource.data.keys().hasAll(['title', 'images'])
                    && request.resource.data.title is string
                    && request.resource.data.title.size() > 0
                    && request.resource.data.images is list;

      // 수정: 제목, 설명, 카테고리, 이미지 필드 업데이트 허용
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['title', 'description', 'category', 'images', 'updatedAt']);

      // 삭제: 인증된 사용자만 허용 (관리자 페이지에서 코드 검증 후 삭제)
      allow delete: if request.auth != null;
    }

    // 의제별 투표 컬렉션 (법왜곡죄, 내란전담재판부, 시민법관참심제)
    // 문서 ID = 사용자 UID로 중복 투표 방지
    match /votes_lawDistortion/{oderId} {
      allow read: if true;
      allow create: if request.resource.data.vote in ['agree', 'disagree']
                    && request.resource.data.keys().hasAll(['vote', 'createdAt', 'userId'])
                    && request.resource.data.userId == oderId;
      allow update, delete: if false;
    }

    match /votes_trialCourt/{oderId} {
      allow read: if true;
      allow create: if request.resource.data.vote in ['agree', 'disagree']
                    && request.resource.data.keys().hasAll(['vote', 'createdAt', 'userId'])
                    && request.resource.data.userId == oderId;
      allow update, delete: if false;
    }

    match /votes_jurySystem/{oderId} {
      allow read: if true;
      allow create: if request.resource.data.vote in ['agree', 'disagree']
                    && request.resource.data.keys().hasAll(['vote', 'createdAt', 'userId'])
                    && request.resource.data.userId == oderId;
      allow update, delete: if false;
    }

    // 의제별 댓글 컬렉션
    match /comments_lawDistortion/{commentId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll(['content', 'author', 'position'])
                    && request.resource.data.content is string
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() <= 500
                    && request.resource.data.author is string
                    && request.resource.data.author.size() > 0
                    && request.resource.data.author.size() <= 20
                    && request.resource.data.position in ['agree', 'disagree', 'alternative'];
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']);
      allow delete: if false;
    }

    match /comments_trialCourt/{commentId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll(['content', 'author', 'position'])
                    && request.resource.data.content is string
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() <= 500
                    && request.resource.data.author is string
                    && request.resource.data.author.size() > 0
                    && request.resource.data.author.size() <= 20
                    && request.resource.data.position in ['agree', 'disagree', 'alternative'];
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']);
      allow delete: if false;
    }

    match /comments_jurySystem/{commentId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll(['content', 'author', 'position'])
                    && request.resource.data.content is string
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() <= 500
                    && request.resource.data.author is string
                    && request.resource.data.author.size() > 0
                    && request.resource.data.author.size() <= 20
                    && request.resource.data.position in ['agree', 'disagree', 'alternative'];
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']);
      allow delete: if false;
    }

    // 동적으로 생성되는 주제의 투표 컬렉션 (votes_로 시작하는 모든 컬렉션)
    // 문서 ID = 사용자 UID로 중복 투표 방지 (관리자 테스트 ID 허용)
    match /{collection}/{oderId} {
      allow read: if collection.matches('votes_.*');
      allow create: if collection.matches('votes_.*')
                    && request.resource.data.vote in ['agree', 'disagree']
                    && request.resource.data.keys().hasAll(['vote', 'createdAt', 'userId'])
                    && request.resource.data.userId is string
                    && (request.resource.data.userId == oderId || oderId.matches('admin_test_.*'));
      allow update, delete: if false;
    }

    // 동적으로 생성되는 주제의 댓글 컬렉션 (comments_로 시작하는 모든 컬렉션)
    match /{collection}/{commentId} {
      allow read: if collection.matches('comments_.*');
      allow create: if collection.matches('comments_.*')
                    && request.resource.data.keys().hasAll(['content', 'author', 'position'])
                    && request.resource.data.content is string
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() <= 500
                    && request.resource.data.author is string
                    && request.resource.data.author.size() > 0
                    && request.resource.data.author.size() <= 20
                    && request.resource.data.position in ['agree', 'disagree', 'alternative'];
      allow update: if collection.matches('comments_.*')
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']);
      allow delete: if false;
    }

    // 시민 제안 컬렉션
    match /proposals/{proposalId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll(['title', 'description', 'proposerName', 'createdAt', 'status'])
                    && request.resource.data.title is string
                    && request.resource.data.title.size() > 0
                    && request.resource.data.title.size() <= 50
                    && request.resource.data.description is string
                    && request.resource.data.description.size() > 0
                    && request.resource.data.description.size() <= 500
                    && request.resource.data.proposerName is string
                    && request.resource.data.proposerName.size() > 0
                    && request.resource.data.proposerName.size() <= 20
                    && request.resource.data.status == 'proposal';
      // 자동 승격/반려 시 상태 업데이트 허용
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['status', 'promotedAt', 'rejectedAt', 'rejectedReason'])
                    && request.resource.data.status in ['proposal', 'promoted', 'rejected'];
      // 관리자 삭제 허용 (인증된 사용자만, 클라이언트에서 관리자 코드 검증 후 삭제)
      allow delete: if request.auth != null;
    }

    // 제안 추천(지지) 컬렉션 (proposal_supports_로 시작하는 모든 컬렉션)
    // 문서 ID = 사용자 UID로 중복 추천 방지 (관리자 테스트 ID 허용)
    match /{collection}/{oderId} {
      allow read: if collection.matches('proposal_supports_.*');
      allow create: if collection.matches('proposal_supports_.*')
                    && request.resource.data.keys().hasAll(['createdAt', 'userId'])
                    && request.resource.data.userId is string
                    && (request.resource.data.userId == oderId || oderId.matches('admin_test_.*'));
      allow update, delete: if false;
    }

    // 설정 컬렉션: 읽기는 모두 허용
    // governance 설정은 제안 승격 시 topics 필드 업데이트 허용 (카카오 로그인 사용자 포함)
    // 기타 설정은 인증된 사용자만 허용
    match /settings/{settingId} {
      allow read: if true;
      allow create, update: if request.auth != null
                            || (settingId == 'governance'
                                && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['topics']));
      allow delete: if false;
    }

    // 투표 조정 로그 컬렉션 (관리자 투표 수 조정 이력)
    match /vote_adjustments/{logId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll(['topicId', 'reason', 'adjustedAt'])
                    && request.resource.data.reason is string
                    && request.resource.data.reason.size() > 0;
      allow update, delete: if false;
    }

    // 활동 로그 컬렉션 (보안 추적용)
    // - 로그인/로그아웃, 투표, 댓글, 서명 등 모든 활동 기록
    // - 읽기: 불가 (관리자만 Firebase Console에서 확인)
    // - 생성: 필수 필드 검증 후 허용
    // - 수정/삭제: 불가 (로그 무결성 유지)
    match /activity_logs/{logId} {
      allow read: if false;
      allow create: if request.resource.data.keys().hasAll(['userId', 'actionType', 'timestamp'])
                    && request.resource.data.userId is string
                    && request.resource.data.actionType is string
                    && request.resource.data.actionType in ['login', 'logout', 'login_failure', 'vote', 'comment', 'signature', 'proposal', 'proposal_support', 'admin_action'];
      allow update, delete: if false;
    }

    // 양형 분석 데이터: 읽기 허용 (프론트엔드에서 Firestore SDK로 직접 조회)
    match /sentencingData/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // 판사 관련 데이터: 읽기 허용
    match /judgeData/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /judgeYouTubeData/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /judgeCourtCases/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // 내란 재판 판결 데이터: 읽기 허용
    match /insurrectionVerdicts/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // 내란 재판 재판부 구성 데이터: 읽기 허용
    match /insurrectionCourts/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // 사법개혁 뉴스 데이터: 읽기 허용
    match /reformNews/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // 기타 모든 컬렉션: 접근 불가
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
