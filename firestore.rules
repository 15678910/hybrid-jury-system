rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // signatures 컬렉션: 서명 데이터
    match /signatures/{signatureId} {
      // 읽기: 모든 사용자 허용 (공개 서명 목록)
      allow read: if true;

      // 생성: 필수 필드가 있고 유효한 데이터인 경우만 허용
      allow create: if request.resource.data.keys().hasAll(['name', 'phone', 'type', 'timestamp'])
                    && request.resource.data.name is string
                    && request.resource.data.name.size() > 0
                    && request.resource.data.name.size() <= 50
                    && request.resource.data.phone is string
                    && request.resource.data.type in ['individual', 'organization'];

      // 수정/삭제: 불가 (서명은 수정/삭제 불가)
      allow update, delete: if false;
    }

    // posts 컬렉션: 블로그 글
    match /posts/{postId} {
      // 읽기: 모든 사용자 허용 (공개 블로그)
      allow read: if true;

      // 생성: 필수 필드가 있는 경우 허용
      allow create: if request.resource.data.keys().hasAll(['title', 'content', 'author'])
                    && request.resource.data.title is string
                    && request.resource.data.content is string;

      // 수정: 좋아요 업데이트 또는 전체 수정 허용
      allow update: if true;

      allow delete: if false;

      // 댓글 서브컬렉션
      match /comments/{commentId} {
        allow read: if true;
        allow create: if request.resource.data.keys().hasAll(['nickname', 'content'])
                      && request.resource.data.nickname is string
                      && request.resource.data.content is string;
        allow update, delete: if false;
      }
    }

    // videos 컬렉션: 동영상
    match /videos/{videoId} {
      // 읽기: 모든 사용자 허용 (공개 동영상 목록)
      allow read: if true;

      // 생성/수정: 관리자만 (프론트엔드에서 writerCode 검증)
      allow create, update: if request.resource.data.title is string
                            && request.resource.data.title.size() > 0;
      allow delete: if false;
    }

    // 의제별 투표 컬렉션 (법왜곡죄, 내란전담재판부, 시민법관참심제)
    match /votes_lawDistortion/{voteId} {
      allow read: if true;
      allow create: if request.resource.data.vote in ['agree', 'disagree'];
      allow update, delete: if false;
    }

    match /votes_trialCourt/{voteId} {
      allow read: if true;
      allow create: if request.resource.data.vote in ['agree', 'disagree'];
      allow update, delete: if false;
    }

    match /votes_jurySystem/{voteId} {
      allow read: if true;
      allow create: if request.resource.data.vote in ['agree', 'disagree'];
      allow update, delete: if false;
    }

    // 의제별 댓글 컬렉션
    match /comments_lawDistortion/{commentId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll(['content', 'author', 'position'])
                    && request.resource.data.content is string
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() <= 500
                    && request.resource.data.author is string
                    && request.resource.data.author.size() > 0
                    && request.resource.data.author.size() <= 20
                    && request.resource.data.position in ['agree', 'disagree', 'alternative'];
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']);
      allow delete: if false;
    }

    match /comments_trialCourt/{commentId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll(['content', 'author', 'position'])
                    && request.resource.data.content is string
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() <= 500
                    && request.resource.data.author is string
                    && request.resource.data.author.size() > 0
                    && request.resource.data.author.size() <= 20
                    && request.resource.data.position in ['agree', 'disagree', 'alternative'];
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']);
      allow delete: if false;
    }

    match /comments_jurySystem/{commentId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll(['content', 'author', 'position'])
                    && request.resource.data.content is string
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() <= 500
                    && request.resource.data.author is string
                    && request.resource.data.author.size() > 0
                    && request.resource.data.author.size() <= 20
                    && request.resource.data.position in ['agree', 'disagree', 'alternative'];
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']);
      allow delete: if false;
    }

    // 동적으로 생성되는 주제의 투표 컬렉션 (votes_로 시작하는 모든 컬렉션)
    match /{collection}/{voteId} {
      allow read: if collection.matches('votes_.*');
      allow create: if collection.matches('votes_.*')
                    && request.resource.data.vote in ['agree', 'disagree'];
      allow update, delete: if false;
    }

    // 동적으로 생성되는 주제의 댓글 컬렉션 (comments_로 시작하는 모든 컬렉션)
    match /{collection}/{commentId} {
      allow read: if collection.matches('comments_.*');
      allow create: if collection.matches('comments_.*')
                    && request.resource.data.keys().hasAll(['content', 'author', 'position'])
                    && request.resource.data.content is string
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() <= 500
                    && request.resource.data.author is string
                    && request.resource.data.author.size() > 0
                    && request.resource.data.author.size() <= 20
                    && request.resource.data.position in ['agree', 'disagree', 'alternative'];
      allow update: if collection.matches('comments_.*')
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']);
      allow delete: if false;
    }

    // 시민 제안 컬렉션
    match /proposals/{proposalId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll(['title', 'description', 'proposerName', 'createdAt', 'status'])
                    && request.resource.data.title is string
                    && request.resource.data.title.size() > 0
                    && request.resource.data.title.size() <= 50
                    && request.resource.data.description is string
                    && request.resource.data.description.size() > 0
                    && request.resource.data.description.size() <= 500
                    && request.resource.data.proposerName is string
                    && request.resource.data.proposerName.size() > 0
                    && request.resource.data.proposerName.size() <= 20
                    && request.resource.data.status == 'proposal';
      allow update, delete: if false;
    }

    // 제안 추천(지지) 컬렉션 (proposal_supports_로 시작하는 모든 컬렉션)
    match /{collection}/{supportId} {
      allow read: if collection.matches('proposal_supports_.*');
      allow create: if collection.matches('proposal_supports_.*')
                    && request.resource.data.keys().hasAll(['createdAt']);
      allow update, delete: if false;
    }

    // 기타 모든 컬렉션: 접근 불가
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
