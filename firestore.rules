rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // signatures 컬렉션: 서명 데이터
    match /signatures/{signatureId} {
      // 읽기: 모든 사용자 허용 (공개 서명 목록)
      allow read: if true;

      // 생성: 필수 필드가 있고 유효한 데이터인 경우만 허용
      allow create: if request.resource.data.keys().hasAll(['name', 'phone', 'type', 'timestamp'])
                    && request.resource.data.name is string
                    && request.resource.data.name.size() > 0
                    && request.resource.data.name.size() <= 50
                    && request.resource.data.phone is string
                    && request.resource.data.type in ['individual', 'organization'];

      // 수정/삭제: 불가 (서명은 수정/삭제 불가)
      allow update, delete: if false;
    }

    // posts 컬렉션: 블로그 글
    match /posts/{postId} {
      // 읽기: 모든 사용자 허용 (공개 블로그)
      allow read: if true;

      // 생성: 필수 필드가 있는 경우 허용
      allow create: if request.resource.data.keys().hasAll(['title', 'content', 'author'])
                    && request.resource.data.title is string
                    && request.resource.data.content is string;

      // 수정: 좋아요 업데이트 또는 전체 수정 허용
      allow update: if true;

      allow delete: if false;

      // 댓글 서브컬렉션
      match /comments/{commentId} {
        allow read: if true;
        allow create: if request.resource.data.keys().hasAll(['nickname', 'content'])
                      && request.resource.data.nickname is string
                      && request.resource.data.content is string;
        allow update, delete: if false;
      }
    }

    // videos 컬렉션: 동영상
    match /videos/{videoId} {
      // 읽기: 모든 사용자 허용 (공개 동영상 목록)
      allow read: if true;

      // 생성/수정: 관리자만 (프론트엔드에서 writerCode 검증)
      allow create, update: if request.resource.data.title is string
                            && request.resource.data.title.size() > 0;
      allow delete: if false;
    }

    // 기타 모든 컬렉션: 접근 불가
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
